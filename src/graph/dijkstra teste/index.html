<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Teste de Grafo Direcional</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    svg {
      border: 1px solid #ccc;
    }
    .link {
      stroke: #aaa;
      stroke-width: 1.5px;
    }
    .link.path {
      stroke: limegreen;
      stroke-width: 3px;
    }
    .arrow {
      fill: #aaa;
    }
    .node {
      fill: #69b3a2;
      stroke: #fff;
      stroke-width: 1.5px;
      cursor: pointer;
    }
    .node.selected {
      fill: orange;
    }
    .node.path {
      fill: limegreen;
    }
  </style>
</head>
<body>
  <h2>Teste de Grafo Direcional (com Arestas de Mão Única ou Dupla)</h2>
  <input type="file" id="fileInput" accept=".json">
  <label for="origemSelect">Origem:</label>
  <select id="origemSelect"></select>
  <label for="destinoSelect">Destino:</label>
  <select id="destinoSelect"></select>
  <button onclick="executarDijkstra()">Calcular Caminho</button>
  <svg width="1000" height="800"></svg>
  <pre id="info"></pre>

  <script type="module">
    import { Grafo } from './grafo.js';

    const svg = d3.select("svg");
    let grafo = new Grafo();
    let nodes = [], links = [];

    const origemSelect = document.getElementById("origemSelect");
    const destinoSelect = document.getElementById("destinoSelect");

    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = JSON.parse(e.target.result);
        grafo = new Grafo();
        grafo.carregarDoJSON(data);
        nodes = data.nodes;
        links = data.edges.map(e => ({
          source: e.from,
          target: e.to,
          bidirectional: e.bidirectional !== false
        }));
        preencherDropdowns();
        desenharGrafo();
      };
      reader.readAsText(file);
    });

    function preencherDropdowns() {
      [origemSelect, destinoSelect].forEach(select => {
        select.innerHTML = '';
        nodes.forEach(n => {
          const option = document.createElement("option");
          option.value = n.id;
          option.textContent = `Vértice ${n.id}`;
          select.appendChild(option);
        });
      });
    }

    function desenharGrafo() {
      svg.selectAll("*").remove();
      const xExtent = d3.extent(nodes, d => d.x);
      const yExtent = d3.extent(nodes, d => d.y);
      const xScale = d3.scaleLinear().domain(xExtent).range([50, 950]);
      const yScale = d3.scaleLinear().domain(yExtent).range([50, 750]);

      svg.selectAll(".link")
        .data(links)
        .enter()
        .append("line")
        .attr("class", d => d.bidirectional ? "link" : "link directional")
        .attr("x1", d => xScale(grafo.vertices.get(d.source).x))
        .attr("y1", d => yScale(grafo.vertices.get(d.source).y))
        .attr("x2", d => xScale(grafo.vertices.get(d.target).x))
        .attr("y2", d => yScale(grafo.vertices.get(d.target).y));

      svg.selectAll(".arrow")
        .data(links.filter(d => !d.bidirectional))
        .enter()
        .append("circle")
        .attr("class", "arrow")
        .attr("r", 3)
        .attr("cx", d => (xScale(grafo.vertices.get(d.source).x) + xScale(grafo.vertices.get(d.target).x)) / 2)
        .attr("cy", d => (yScale(grafo.vertices.get(d.source).y) + yScale(grafo.vertices.get(d.target).y)) / 2);

      svg.selectAll(".node")
        .data(nodes)
        .enter()
        .append("circle")
        .attr("class", "node")
        .attr("r", 5)
        .attr("cx", d => xScale(d.x))
        .attr("cy", d => yScale(d.y));
    }

    window.executarDijkstra = function() {
      const origem = parseInt(origemSelect.value);
      const destino = parseInt(destinoSelect.value);
      const resultado = grafo.dijkstra(origem, destino);

      document.getElementById("info").textContent = `Caminho: ${resultado.caminho.join(" → ")}\nCusto: ${resultado.custo.toFixed(2)}\nNós visitados: ${resultado.visitados}`;

      svg.selectAll(".node")
        .classed("path", d => resultado.caminho.includes(d.id));

      svg.selectAll(".link")
        .classed("path", d => {
          for (let i = 0; i < resultado.caminho.length - 1; i++) {
            if ((d.source === resultado.caminho[i] && d.target === resultado.caminho[i + 1]) ||
                (d.bidirectional && d.target === resultado.caminho[i] && d.source === resultado.caminho[i + 1])) {
              return true;
            }
          }
          return false;
        });
    }
  </script>
</body>
</html>